(function(){"use strict";const i=window.Vue;function $(){return window.panel}function U(){return $().api}function ce(){const r=U();return{load:({parent:n,name:e})=>r.get(`${n}/sections/${e}`)}}function le(){var t;return((t=i.getCurrentInstance())==null?void 0:t.proxy).$store}const W=i.computed;i.customRef,i.defineAsyncComponent,i.defineComponent,i.effectScope,i.getCurrentInstance,i.getCurrentScope,i.h,i.inject,i.isProxy,i.isReactive,i.isReadonly,i.isRef,i.isShallow,i.markRaw;const ue=i.nextTick;i.onActivated,i.onBeforeMount;const pe=i.onBeforeUnmount;i.onBeforeUpdate,i.onDeactivated,i.onErrorCaptured,i.onMounted,i.onRenderTracked,i.onRenderTriggered,i.onScopeDispose,i.onServerPrefetch,i.onUnmounted,i.onUpdated,i.provide,i.proxyRefs,i.reactive,i.readonly;const g=i.ref;i.shallowReactive,i.shallowReadonly,i.shallowRef,i.toRaw,i.toRef,i.toRefs,i.triggerRef,i.unref,i.useAttrs,i.useCssModule,i.useCssVars,i.useListeners,i.useSlots;const J=i.watch;i.watchEffect,i.watchPostEffect,i.watchSyncEffect;const de={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},O={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Get your order number</a> from Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.licenseKey":"License key invalid for this plugin",activate:"Activate",activated:"Plugin activated"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'Rufe die <a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Bestellnummer von Lemon Squeezy ab</a> oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin",activate:"Aktivieren",activated:"Plugin aktiviert"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'Obtenez votre numéro de commande sur <a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Lemon Squeezy</a> ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin",activate:"Activer",activated:"Plugin activé"}};function T(r,t,n){var c;const o=$().translation.code,a=((c=O==null?void 0:O[o])==null?void 0:c[r])??n;if(a)return t?fe(a,t):a}function fe(r,t,n){return r.replace(/\{(\w+)\}/g,(e,o)=>t[o]||o)}const he=["localhost","127.0.0.1","[::1]"],me=["local","test","ddev.site"];function ge({label:r,apiNamespace:t}){const n=$(),e=U(),o=ye(),a=async(u,s)=>{if(!u||!s)throw new Error("Email and order ID are required");const f=await e.post(`${t}/register`,{email:u,orderId:s});if((f==null?void 0:f.status)!=="ok")throw new Error("Registration failed");return!0};return{isLocalhost:o,openLicenseModal:()=>{let u=!1;return new Promise(s=>{n.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:T("activate",{label:r})},fields:{info:{type:"info",text:T("modal.info",{label:r})},email:{label:n.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:T("modal.fields.orderId.help",{label:r})}}},on:{close:()=>{s({isRegistered:u})},submit:async f=>{const{email:h,orderId:m}=f;if(!h||!m){n.notification.error(T("modal.error.required.fields"));return}try{await a(h,Number(m))}catch(l){let k=l.message;k==="License key not valid for this plugin"&&(k=T("modal.error.invalid.licenseKey")),n.notification.error(k);return}u=!0,n.dialog.close(),n.notification.success(T("activated"),{label:r})}}})})}}}function ye(){const{hostname:r}=window.location,t=he.includes(r),n=me.some(e=>r.endsWith(`.${e}`));return t||n}const ve=["openai","mistral"],K=["image/png","image/jpeg","image/webp","image/gif"],_e=["error","warn","info","debug"],we="kirby$copilot$";let M=[];const N=new Map;async function be(r){if(!Array.isArray(r))throw new TypeError("Expected an array of assets");M.length>0||(M=r)}function Y(r){if(M.length===0)throw new Error("Plugin assets are not registered");const t=M.find(n=>n.filename===r);if(!t)throw new Error(`Plugin asset "${r}" not found`);return t}async function X(r){if(r.endsWith(".js")||(r+=".js"),N.has(r))return N.get(r);const n=await import(Y(r).url);return N.set(r,n),n}function xe(r,t,n){return r.replace(/\{(\w+)\}/g,(e,o)=>t[o.toLowerCase()]||o)}let z;async function ke(r){const t=await Pe(),n=await r.arrayBuffer(),e=await t.getDocument({data:n,useSystemFonts:!0}).promise;return(await Promise.all(Array.from({length:e.numPages},(a,c)=>Se(e,c+1)))).join(`
`).replace(/\s+/g," ")}async function Se(r,t){return(await(await r.getPage(t)).getTextContent()).items.filter(o=>o.str!=null).map(o=>o.str).join(" ")}async function Pe(){if(z)return z;z=await X("pdfjs");const r=Y("pdfjs.worker.js");return z.GlobalWorkerOptions.workerSrc=r.url,z}class Be{constructor(){this.defaultColor="#7f8c8d",this.levelColorMap={0:"#c0392b",1:"#f39c12",2:"#00BCD4"},this.typeColorMap={success:"#2ecc71"}}_getLogFn(t){return t<1?console.error:console.log}log(t){const n=this._getLogFn(t.level),e=t.type==="log"?"":t.type,o=t.tag||"",c=`
  background: ${this.typeColorMap[t.type]||this.levelColorMap[t.level]||this.defaultColor};
  border-radius: 0.5em;
  color: white;
  font-weight: bold;
  padding: 2px 0.5em;
`.trimStart(),u=`%c${[o,e].filter(Boolean).join(":")}`;typeof t.args[0]=="string"?n(`${u}%c ${t.args[0]}`,c,"",...t.args.slice(1)):n(u,c,...t.args)}}const Ce={error:0,warn:1,info:2};function Ee(r){const t=new Be;return new Proxy({},{get(n,e){return(...o)=>{t.log({level:Ce[e],type:e,tag:r,args:o})}}})}let Le;function Re(){return Le??(Le=Ee("copilot"))}async function Ae({userPrompt:r,systemPrompt:t,context:n,files:e,config:o,logLevel:a,abortSignal:c}){const u=Re(),{createMistral:s,createOpenAI:f,experimental_streamText:h}=await X("ai"),m=o.provider,l=o.providers[m],k={mistral:s,openai:f}[m],P=k({baseUrl:l.baseUrl||void 0,apiKey:l.apiKey}),F=e.filter(v=>v.type.startsWith("image/")),L=e.filter(v=>v.type==="application/pdf");let b=xe(r,n);if(L.length>0){const y=`Additional context from the following PDF documents has been processed and made available to you. Include the information from these documents as applicable.

${(await Promise.all(L.map(ke))).map((B,w)=>`PDF document ${w+1}: ${B}`).join(`

`)}`;b+=`

${y}`}if(a>1&&(u.info("System prompt:",t),u.info("User prompt with context:",b)),m==="openai"&&F.length>0){const v=await Promise.all(F.map(async y=>{const B=await y.arrayBuffer();return{data:new Uint8Array(B),mimeType:y.type}}));return h({model:P.chat(l.model),temperature:o.temperature,maxTokens:o.maxGenerationTokens,system:t,messages:[{role:"user",content:[{type:"text",text:b},...v.map(y=>({type:"image",image:y.data}))]}],abortSignal:c})}return h({model:P.chat(l.model),temperature:o.temperature,maxTokens:o.maxGenerationTokens,system:t,prompt:b,abortSignal:c})}const Q=Object.freeze({ignoreUnknown:!1,respectType:!1,respectFunctionNames:!1,respectFunctionProperties:!1,unorderedObjects:!0,unorderedArrays:!1,unorderedSets:!1,excludeKeys:void 0,excludeValues:void 0,replacer:void 0});function je(r,t){t?t={...Q,...t}:t=Q;const n=Z(t);return n.dispatch(r),n.toString()}const Fe=Object.freeze(["prototype","__proto__","constructor"]);function Z(r){let t="",n=new Map;const e=o=>{t+=o};return{toString(){return t},getContext(){return n},dispatch(o){return r.replacer&&(o=r.replacer(o)),this[o===null?"null":typeof o](o)},object(o){if(o&&typeof o.toJSON=="function")return this.object(o.toJSON());const a=Object.prototype.toString.call(o);let c="";const u=a.length;u<10?c="unknown:["+a+"]":c=a.slice(8,u-1),c=c.toLowerCase();let s=null;if((s=n.get(o))===void 0)n.set(o,n.size);else return this.dispatch("[CIRCULAR:"+s+"]");if(typeof Buffer<"u"&&Buffer.isBuffer&&Buffer.isBuffer(o))return e("buffer:"),e(o.toString("utf8"));if(c!=="object"&&c!=="function"&&c!=="asyncfunction")this[c]?this[c](o):r.ignoreUnknown||this.unkown(o,c);else{let f=Object.keys(o);r.unorderedObjects&&(f=f.sort());let h=[];r.respectType!==!1&&!te(o)&&(h=Fe),r.excludeKeys&&(f=f.filter(l=>!r.excludeKeys(l)),h=h.filter(l=>!r.excludeKeys(l))),e("object:"+(f.length+h.length)+":");const m=l=>{this.dispatch(l),e(":"),r.excludeValues||this.dispatch(o[l]),e(",")};for(const l of f)m(l);for(const l of h)m(l)}},array(o,a){if(a=a===void 0?r.unorderedArrays!==!1:a,e("array:"+o.length+":"),!a||o.length<=1){for(const s of o)this.dispatch(s);return}const c=new Map,u=o.map(s=>{const f=Z(r);f.dispatch(s);for(const[h,m]of f.getContext())c.set(h,m);return f.toString()});return n=c,u.sort(),this.array(u,!1)},date(o){return e("date:"+o.toJSON())},symbol(o){return e("symbol:"+o.toString())},unkown(o,a){if(e(a),!!o&&(e(":"),o&&typeof o.entries=="function"))return this.array(Array.from(o.entries()),!0)},error(o){return e("error:"+o.toString())},boolean(o){return e("bool:"+o)},string(o){e("string:"+o.length+":"),e(o)},function(o){e("fn:"),te(o)?this.dispatch("[native]"):this.dispatch(o.toString()),r.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(o.name)),r.respectFunctionProperties&&this.object(o)},number(o){return e("number:"+o)},xml(o){return e("xml:"+o.toString())},null(){return e("Null")},undefined(){return e("Undefined")},regexp(o){return e("regex:"+o.toString())},uint8array(o){return e("uint8array:"),this.dispatch(Array.prototype.slice.call(o))},uint8clampedarray(o){return e("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(o))},int8array(o){return e("int8array:"),this.dispatch(Array.prototype.slice.call(o))},uint16array(o){return e("uint16array:"),this.dispatch(Array.prototype.slice.call(o))},int16array(o){return e("int16array:"),this.dispatch(Array.prototype.slice.call(o))},uint32array(o){return e("uint32array:"),this.dispatch(Array.prototype.slice.call(o))},int32array(o){return e("int32array:"),this.dispatch(Array.prototype.slice.call(o))},float32array(o){return e("float32array:"),this.dispatch(Array.prototype.slice.call(o))},float64array(o){return e("float64array:"),this.dispatch(Array.prototype.slice.call(o))},arraybuffer(o){return e("arraybuffer:"),this.dispatch(new Uint8Array(o))},url(o){return e("url:"+o.toString())},map(o){e("map:");const a=[...o];return this.array(a,r.unorderedSets!==!1)},set(o){e("set:");const a=[...o];return this.array(a,r.unorderedSets!==!1)},file(o){return e("file:"),this.dispatch([o.name,o.size,o.type,o.lastModfied])},blob(){if(r.ignoreUnknown)return e("[blob]");throw new Error(`Hashing Blob objects is currently not supported
Use "options.replacer" or "options.ignoreUnknown"
`)},domwindow(){return e("domwindow")},bigint(o){return e("bigint:"+o.toString())},process(){return e("process")},timer(){return e("timer")},pipe(){return e("pipe")},tcp(){return e("tcp")},udp(){return e("udp")},tty(){return e("tty")},statwatcher(){return e("statwatcher")},securecontext(){return e("securecontext")},connection(){return e("connection")},zlib(){return e("zlib")},context(){return e("context")},nodescript(){return e("nodescript")},httpparser(){return e("httpparser")},dataview(){return e("dataview")},signal(){return e("signal")},fsevent(){return e("fsevent")},tlswrap(){return e("tlswrap")}}}const ee="[native code] }",Te=ee.length;function te(r){return typeof r!="function"?!1:Function.prototype.toString.call(r).slice(-Te)===ee}class E{constructor(t,n){t=this.words=t||[],this.sigBytes=n===void 0?t.length*4:n}toString(t){return(t||ze).stringify(this)}concat(t){if(this.clamp(),this.sigBytes%4)for(let n=0;n<t.sigBytes;n++){const e=t.words[n>>>2]>>>24-n%4*8&255;this.words[this.sigBytes+n>>>2]|=e<<24-(this.sigBytes+n)%4*8}else for(let n=0;n<t.sigBytes;n+=4)this.words[this.sigBytes+n>>>2]=t.words[n>>>2];return this.sigBytes+=t.sigBytes,this}clamp(){this.words[this.sigBytes>>>2]&=4294967295<<32-this.sigBytes%4*8,this.words.length=Math.ceil(this.sigBytes/4)}clone(){return new E([...this.words])}}const ze={stringify(r){const t=[];for(let n=0;n<r.sigBytes;n++){const e=r.words[n>>>2]>>>24-n%4*8&255;t.push((e>>>4).toString(16),(e&15).toString(16))}return t.join("")}},Ie={stringify(r){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=[];for(let e=0;e<r.sigBytes;e+=3){const o=r.words[e>>>2]>>>24-e%4*8&255,a=r.words[e+1>>>2]>>>24-(e+1)%4*8&255,c=r.words[e+2>>>2]>>>24-(e+2)%4*8&255,u=o<<16|a<<8|c;for(let s=0;s<4&&e*8+s*6<r.sigBytes*8;s++)n.push(t.charAt(u>>>6*(3-s)&63))}return n.join("")}},$e={parse(r){const t=r.length,n=[];for(let e=0;e<t;e++)n[e>>>2]|=(r.charCodeAt(e)&255)<<24-e%4*8;return new E(n,t)}},Me={parse(r){return $e.parse(unescape(encodeURIComponent(r)))}};class De{constructor(){this._data=new E,this._nDataBytes=0,this._minBufferSize=0,this.blockSize=512/32}reset(){this._data=new E,this._nDataBytes=0}_append(t){typeof t=="string"&&(t=Me.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes}_doProcessBlock(t,n){}_process(t){let n,e=this._data.sigBytes/(this.blockSize*4);t?e=Math.ceil(e):e=Math.max((e|0)-this._minBufferSize,0);const o=e*this.blockSize,a=Math.min(o*4,this._data.sigBytes);if(o){for(let c=0;c<o;c+=this.blockSize)this._doProcessBlock(this._data.words,c);n=this._data.words.splice(0,o),this._data.sigBytes-=a}return new E(n,a)}}class Ue extends De{update(t){return this._append(t),this._process(),this}finalize(t){t&&this._append(t)}}const ne=[1779033703,-1150833019,1013904242,-1521486534,1359893119,-1694144372,528734635,1541459225],Oe=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],j=[];class Ke extends Ue{constructor(){super(...arguments),this._hash=new E([...ne])}reset(){super.reset(),this._hash=new E([...ne])}_doProcessBlock(t,n){const e=this._hash.words;let o=e[0],a=e[1],c=e[2],u=e[3],s=e[4],f=e[5],h=e[6],m=e[7];for(let l=0;l<64;l++){if(l<16)j[l]=t[n+l]|0;else{const y=j[l-15],B=(y<<25|y>>>7)^(y<<14|y>>>18)^y>>>3,w=j[l-2],_=(w<<15|w>>>17)^(w<<13|w>>>19)^w>>>10;j[l]=B+j[l-7]+_+j[l-16]}const k=s&f^~s&h,P=o&a^o&c^a&c,F=(o<<30|o>>>2)^(o<<19|o>>>13)^(o<<10|o>>>22),L=(s<<26|s>>>6)^(s<<21|s>>>11)^(s<<7|s>>>25),b=m+L+k+Oe[l]+j[l],v=F+P;m=h,h=f,f=s,s=u+b|0,u=c,c=a,a=o,o=b+v|0}e[0]=e[0]+o|0,e[1]=e[1]+a|0,e[2]=e[2]+c|0,e[3]=e[3]+u|0,e[4]=e[4]+s|0,e[5]=e[5]+f|0,e[6]=e[6]+h|0,e[7]=e[7]+m|0}finalize(t){super.finalize(t);const n=this._nDataBytes*8,e=this._data.sigBytes*8;return this._data.words[e>>>5]|=128<<24-e%32,this._data.words[(e+64>>>9<<4)+14]=Math.floor(n/4294967296),this._data.words[(e+64>>>9<<4)+15]=n,this._data.sigBytes=this._data.words.length*4,this._process(),this._hash}}function Ne(r){return new Ke().finalize(r).toString(Ie)}function qe(r,t={}){const n=typeof r=="string"?r:je(r,t);return Ne(n).slice(0,10)}function He(...r){return`${we}${qe([...r])}`}let S;async function Ve({accept:r="*",multiple:t=!0}={}){return S=document.createElement("input"),S.type="file",S.classList.add("sr-only"),S.value=null,S.accept=r,S.multiple=t,S.click(),new Promise(n=>{S.addEventListener("change",e=>{n([...e.target.files]),S.remove()})})}async function Ge(r,{maxSize:t}={}){if(!t)return r;const n=await We(r);return await Je(n,r.type,t)}async function We(r){const t=new Image,n=URL.createObjectURL(r);return t.src=n,await new Promise((e,o)=>{t.onload=()=>{e(t)},t.onerror=()=>{URL.revokeObjectURL(n),o(new Error("Failed to load the image"))}}),URL.revokeObjectURL(n),t}async function Je(r,t,n){const e=document.createElement("canvas"),o=e.getContext("2d");let a=1;n&&(r.width>n||r.height>n)&&(a=n/Math.max(r.width,r.height)),e.width=r.width*a,e.height=r.height*a,o.drawImage(r,0,0,e.width,e.height);const c=await new Promise(u=>{e.toBlob(u,t)});if(!c)throw new Error("Failed to convert canvas to Blob");return c}function Ye(r,t,n,e,o,a,c,u){var s=typeof r=="function"?r.options:r;return t&&(s.render=t,s.staticRenderFns=n,s._compiled=!0),{exports:r,options:s}}const oe={...de},Xe=Object.assign({inheritAttrs:!1},{__name:"Copilot",props:oe,setup(r){const t=r,n=$(),e=U(),o=le(),{openLicenseModal:a}=ge({label:"Kirby Copilot",apiNamespace:"__copilot__"}),c=/^<(\w+)>\s*<\/\1>$/,u=g(),s=g(),f=g(),h=g(),m=g(),l=g(),k=g(),P=g(),F=g(),L=g(),b=g(!1),v=g(!1),y=g(!1),B=g(),w=g(),_=g(),q=g([]),D=g([]);let R,A;const H=W(()=>o.getters["content/values"]()),re=W(()=>!v.value&&_.value!==void 0);J(w,d=>{b.value&&m.value&&(d&&d!==f.value?localStorage.setItem(`${R}$prompt`,d):(!d||d===f.value)&&localStorage.removeItem(`${R}$prompt`))}),J(y,d=>{b.value&&m.value&&(d?localStorage.setItem(`${R}$open`,"true"):localStorage.removeItem(`${R}$open`))}),(async()=>{const{load:d}=ce(),p=await d({parent:t.parent,name:t.name});if(u.value=se(p.label)||n.t("johannschopplich.copilot.label"),s.value=p.field??void 0,f.value=p.userPrompt??void 0,h.value=p.systemPrompt||p.config.systemPrompt||void 0,m.value=p.storage,p.editable===!0&&q.value.push("edit"),p.files===!0&&q.value.push("files"),l.value=_e.indexOf(p.config.logLevel??p.logLevel),k.value=p.supported,P.value=p.config,L.value=p.license,be(p.assets),p.files==="auto"&&p.modelFile){F.value=p.modelFile;const{mime:C,url:x}=p.modelFile;K.includes(C)&&fetch(x).then(I=>I.blob()).then(I=>{D.value=[I]})}m.value&&(R=He(n.view.path,s.value),w.value=localStorage.getItem(`${R}$prompt`)||f.value||"",y.value=localStorage.getItem(`${R}$open`)==="true",ue(()=>{B.value&&y.value&&(B.value.open=!0)})),n.events.on("view.save",G),b.value=!0})(),pe(()=>{n.events.off("view.save",G)});function se(d){return!d||typeof d=="string"?d:d[n.translation.code]??Object.values(d)[0]}async function nt(){if(!w.value){n.notification.error(n.t("johannschopplich.copilot.prompt.empty"));return}n.isLoading=!0,v.value=!0,_.value=H.value[s.value],A=new AbortController;let d="",p=Date.now(),C=P.value;try{const{textStream:x}=await Ae({userPrompt:w.value,systemPrompt:h.value,context:ie(),files:D.value,config:C,logLevel:l.value,abortSignal:A.signal});for await(const I of x)if(d+=I,Array.isArray(_.value)){if(Date.now()-p<P.value.blocksUpdateThrottle)continue;p=Date.now();const ae=await V(d);ae.length>0&&o.dispatch("content/update",[s.value,[..._.value,...ae]])}else o.dispatch("content/update",[s.value,_.value+d])}catch(x){if(A=void 0,n.isLoading=!1,v.value=!1,x instanceof Error&&x.name==="AbortError")return;if(x instanceof Error&&x.name==="ApiCallError"){console.error(x),n.notification.error(x.message);return}console.error(x),n.notification.error(n.t("johannschopplich.copilot.generator.error"));return}o.dispatch("content/update",[s.value,Array.isArray(_.value)?[..._.value,...await V(d)]:_.value+d]),A=void 0,n.isLoading=!1,v.value=!1,n.notification.success({icon:"sparkling",message:n.t("johannschopplich.copilot.generator.success")})}function ot(){A==null||A.abort()}function rt(){o.dispatch("content/update",[s.value,_.value]),_.value=void 0}async function st(){const d=await Ve({accept:[...K,"application/pdf"].join(",")});D.value=await Promise.all(d.map(async p=>p.type.startsWith("image/")?Ge(p,{maxSize:2048}):p))}async function V(d){if(!d)return[];const{blocks:p}=await e.post("__copilot__/html2blocks",{html:d});return p.length===1&&"text"in p[0].content&&c.test(p[0].content.text)?[]:p}function ie(){const d={...H.value,title:n.view.title};return Object.fromEntries(Object.entries(d).map(([p,C])=>[p,Array.isArray(C)||typeof C=="object"&&C!==null?JSON.stringify(C):C]))}function G(){re.value&&(_.value=void 0)}async function it(){const{isRegistered:d}=await a();d&&(L.value=!0)}return{__sfc:!0,propsDefinition:oe,props:t,panel:n,api:e,store:o,openLicenseModal:a,EMPTY_HTML_TAG_RE:c,label:u,field:s,userPrompt:f,systemPrompt:h,storage:m,logLevel:l,supported:k,config:P,modelFile:F,license:L,isInitialized:b,isGenerating:v,isDetailsOpen:y,detailsElement:B,currentPrompt:w,currentFieldContent:_,allow:q,files:D,storageKey:R,abortController:A,currentContent:H,canUndo:re,t:se,generate:nt,abort:ot,undo:rt,pickFiles:st,htmlToBlocks:V,createContext:ie,onModelSave:G,handleRegistration:it,SUPPORTED_PROVIDERS:ve,SUPPORTED_VISION_MIME_TYPES:K}}});var Qe=function(){var o,a,c,u;var t=this,n=t._self._c,e=t._self._setupProxy;return e.isInitialized?n("k-section",{attrs:{label:e.label}},[e.license===!1?n("k-button-group",{attrs:{slot:"options",layout:"collapsed"},slot:"options"},[n("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:"https://kirbycopilot.com/buy",target:"_blank",text:e.panel.t("johannschopplich.copilot.license.buy")}}),n("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:e.panel.t("johannschopplich.copilot.license.activate")},on:{click:function(s){return e.handleRegistration()}}})],1):t._e(),!e.config.provider||!e.SUPPORTED_PROVIDERS.includes(e.config.provider)?n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" Unsupported provider "),n("code",[t._v(t._s(e.config.provider))]),t._v(" in the "),n("code",[t._v("johannschopplich.copilot.provider")]),t._v(" global configuration. ")])],1):(a=(o=e.config.providers)==null?void 0:o[e.config.provider])!=null&&a.apiKey?(u=(c=e.config.providers)==null?void 0:c[e.config.provider])!=null&&u.model?e.field?e.field in e.currentContent?e.supported?!e.allow.includes("edit")&&!e.userPrompt?n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" If the user prompt cannot be edited by the user, a default "),n("code",[t._v("userPrompt")]),t._v(" has to be set in the section configuration. ")])],1):n("div",{staticClass:"kai-space-y-4"},[n("k-button-group",{attrs:{layout:"collapsed"}},[n("k-button",{attrs:{icon:e.isGenerating?"loader":"sparkling",text:e.panel.t("johannschopplich.copilot.generate"),variant:"filled",size:"sm",theme:"positive",disabled:e.isGenerating},on:{click:function(s){return e.generate()}}}),e.isGenerating?n("k-button",{attrs:{icon:"cancel",text:e.panel.t("johannschopplich.copilot.stop"),variant:"filled",size:"sm",theme:"notice"},on:{click:function(s){return e.abort()}}}):t._e(),e.canUndo?n("k-button",{attrs:{icon:"undo",text:e.panel.t("johannschopplich.copilot.undo"),variant:"filled",size:"sm"},on:{click:function(s){return e.undo()}}}):t._e()],1),e.allow.length>0?n("details",{ref:"detailsElement",on:{toggle:function(s){e.isDetailsOpen=s.target.open}}},[n("summary",[t._v(" "+t._s([...e.allow.includes("edit")?[e.panel.t("johannschopplich.copilot.prompt.label")]:[],...e.allow.includes("files")?[e.panel.t("johannschopplich.copilot.context")]:[]].join(", "))+" ")]),n("div",{staticClass:"kai-mt-3"},[e.allow.includes("edit")?n("div",{staticClass:"kai-mb-2 kai-text-right"},[n("k-input",{key:e.isDetailsOpen?1:0,staticClass:"kai-mb-1",attrs:{placeholder:e.panel.t("johannschopplich.copilot.prompt.placeholder"),type:"textarea",buttons:!1,counter:!1},model:{value:e.currentPrompt,callback:function(s){e.currentPrompt=s},expression:"currentPrompt"}}),n("k-button",{directives:[{name:"show",rawName:"v-show",value:e.userPrompt&&e.currentPrompt!==e.userPrompt,expression:"userPrompt && currentPrompt !== userPrompt"}],attrs:{icon:"undo",text:"Reset",size:"xs",variant:"dimmed"},on:{click:function(s){e.currentPrompt=e.userPrompt}}})],1):t._e(),e.allow.includes("files")?n("k-button-group",{attrs:{layout:"collapsed"}},[n("k-button",{attrs:{icon:"upload",text:e.panel.t("johannschopplich.copilot.files.select"),variant:"filled",size:"sm"},on:{click:function(s){return e.pickFiles()}}}),e.files.length>0?n("k-button",{attrs:{icon:"cancel",text:e.panel.t("johannschopplich.copilot.remove"),variant:"filled",size:"sm"},on:{click:function(s){e.files=[]}}}):t._e()],1):e.modelFile?n("k-box",{attrs:{theme:"none"}},[n("k-text",[t._v(" "+t._s(e.panel.t(`johannschopplich.copilot.context.file.${e.SUPPORTED_VISION_MIME_TYPES.includes(e.modelFile.mime)?"model":"unsupported"}`))+" ")])],1):t._e()],1)]):t._e()],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" The "),n("code",[t._v(t._s(e.field))]),t._v(" field is not supported. Use a "),n("code",[t._v("blocks")]),t._v(", "),n("code",[t._v("text")]),t._v(", "),n("code",[t._v("textarea")]),t._v(" or "),n("code",[t._v("textarea")]),t._v(" type. ")])],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" The "),n("code",[t._v(t._s(e.field))]),t._v(" field does not exist in the current model. ")])],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" Missing "),n("code",[t._v("field")]),t._v(" property in the section configuration. It is required for the generated text. ")])],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" Missing "),n("code",[t._v("model")]),t._v(" property in the "),n("code",[t._v(t._s(`johannschopplich.copilot.providers.${e.config.provider}`))]),t._v(" global configuration. ")])],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" Missing "),n("code",[t._v("apiKey")]),t._v(" property in the "),n("code",[t._v(t._s(`johannschopplich.copilot.providers.${e.config.provider}`))]),t._v(" global configuration. ")])],1)],1):t._e()},Ze=[],et=Ye(Xe,Qe,Ze);const tt=et.exports;window.panel.plugin("johannschopplich/copilot",{sections:{copilot:tt}})})();
